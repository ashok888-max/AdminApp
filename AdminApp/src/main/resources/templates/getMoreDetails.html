<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>User Details</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
			background-color: #f4f4f4;
		}

		.container {
			width: 80%;
			margin: auto;
			padding: 20px;
			background-color: white;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			margin-top: 50px;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.header h1 {
			font-size: 24px;
		}

		.logout-btn {
			background-color: #007bff;
			color: white;
			border: none;
			padding: 10px 15px;
			cursor: pointer;
			font-size: 16px;
			border-radius: 5px;
			transition: background-color 0.3s ease;
		}

		.logout-btn:hover {
			background-color: #0056b3;
		}

		.bold-text {
			font-weight: bold;
		}

		.user-info {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}

		.user-info div {
			background-color: #f9f9f9;
			padding: 15px;
			border-radius: 5px;
		}

		.user-info label {
			font-weight: bold;
		}

		.document-section {
			margin-top: 30px;
		}

		.document-section h3 {
			margin-top: 20px;
			font-size: 20px;
			border-bottom: 2px solid #ffffff;
			padding-bottom: 10px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 20px;
		}

		th,
		td {
			padding: 10px;
			border: 1px solid #ddd;
			text-align: left;
		}

		th {
			background-color: #f2f2f2;
		}

		.upload-section {
			margin-top: 20px;
			border: 1px solid #ddd;
			padding: 15px;
			border-radius: 5px;
			background-color: #f9f9f9;
		}

		.upload-section input[type="file"] {
			margin-bottom: 10px;
		}

		.blue-btn {
			background-color: #007bff;
			color: white;
			border: none;
			padding: 10px 15px;
			cursor: pointer;
			font-size: 14px;
			border-radius: 5px;
			transition: background-color 0.3s ease;
		}

		.blue-btn:hover {
			background-color: #0056b3;
		}

		.red-btn {
			background-color: #ff4d4d;
			color: white;
			border: none;
			padding: 10px 15px;
			cursor: pointer;
			font-size: 14px;
			border-radius: 5px;
		}

		.red-btn:hover {
			background-color: #e60000;
		}

		.button {
			background-color: #007bff;
			border: none;
			color: white;
			padding: 10px 20px;
			text-align: center;
			text-decoration: none;
			font-size: 16px;
			cursor: pointer;
			border-radius: 4px;
			display: block;
			margin: 20px auto;
		}

		.button:hover {
			background-color: #0056b3;
		}

		.centered-semicolon {
			text-align: center;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 100;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
		}

		.modal-content {
			background-color: white;
			margin: 15% auto;
			padding: 20px;
			width: 300px;
			border-radius: 8px;
			box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
			text-align: center;
		}

		.modal-content h3 {
			margin-top: 0;
		}

		.modal-button {
			padding: 10px 20px;
			margin: 10px 5px;
			cursor: pointer;
			border: none;
			border-radius: 4px;
		}

		.modal-confirm {
			background-color: #ff4d4d;
			color: white;
		}

		.modal-cancel {
			background-color: #007bff;
			color: white;
		}


		@media (max-width: 768px) {
			.container {
				width: 95%;
				margin-top: 20px;
			}

			.user-details {
				grid-template-columns: 1fr;
				gap: 10px;
			}

			.profile-info {
				flex-direction: column;
				align-items: flex-start;
			}

			.profile-info img {
				margin-bottom: 10px;
			}

			.header h1 {
				font-size: 20px;
			}

			.logout-btn {
				padding: 8px 12px;
				font-size: 14px;
			}

			.treatment-title {
				font-size: 20px;
			}

			.treatment-description {
				font-size: 14px;
			}

			table {
				font-size: 14px;
			}
		}

		@media (max-width: 480px) {
			.profile-info img {
				width: 60px;
				height: 60px;
			}

			.header h1 {
				font-size: 18px;
			}

			.logout-btn {
				padding: 6px 10px;
				font-size: 12px;
			}

			.user-details {
				grid-template-columns: 1fr;
			}

			.bold-text {
				font-size: 14px;
			}

			.treatment-title {
				font-size: 18px;
			}

			.treatment-description {
				font-size: 12px;
			}

			.blue-btn,
			.red-btn {
				padding: 8px 12px;
				font-size: 12px;
			}

			.button {
				padding: 8px 16px;
				font-size: 14px;
			}
		}

		.container {
			width: 80%;
			margin: auto;
			padding: 20px;
			background-color: white;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			margin-top: 50px;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.header h1 {
			font-size: 24px;
		}

		.logout-btn {
			background-color: #007bff;
			color: white;
			border: none;
			padding: 10px 15px;
			cursor: pointer;
			font-size: 16px;
			border-radius: 5px;
			transition: background-color 0.3s ease;
		}

		.logout-btn:hover {
			background-color: #0056b3;
		}

		.bold-text {
			font-weight: bold;
		}

		.user-info {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 20px;
			margin-top: 20px;
		}

		.user-info div {
			background-color: #f9f9f9;
			padding: 15px;
			border-radius: 5px;
		}

		.user-info label {
			font-weight: bold;
		}

		.document-section {
			margin-top: 30px;
		}

		.document-section h3 {
			margin-top: 20px;
			font-size: 20px;
			border-bottom: 2px solid #ffffff;
			padding-bottom: 10px;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 20px;
		}

		th,
		td {
			padding: 10px;
			border: 1px solid #ddd;
			text-align: left;
		}

		th {
			background-color: #f2f2f2;
		}

		.upload-section {
			margin-top: 20px;
			border: 1px solid #ddd;
			padding: 15px;
			border-radius: 5px;
			background-color: #f9f9f9;
		}

		.upload-section input[type="file"] {
			margin-bottom: 10px;
		}

		.blue-btn {
			background-color: #007bff;
			color: white;
			border: none;
			padding: 10px 15px;
			cursor: pointer;
			font-size: 14px;
			border-radius: 5px;
			transition: background-color 0.3s ease;
		}

		.blue-btn:hover {
			background-color: #0056b3;
		}

		.red-btn {
			background-color: #ff4d4d;
			color: white;
			border: none;
			padding: 10px 15px;
			cursor: pointer;
			font-size: 14px;
			border-radius: 5px;
		}

		.red-btn:hover {
			background-color: #e60000;
		}

		.button {
			background-color: #007bff;
			border: none;
			color: white;
			padding: 10px 20px;
			text-align: center;
			text-decoration: none;
			font-size: 16px;
			cursor: pointer;
			border-radius: 4px;
			display: block;
			margin: 20px auto;
		}

		.button:hover {
			background-color: #0056b3;
		}
	</style>
</head>

<body>

	<div class="container">
		<div class="header">
			<h1>Medical Tourism</h1>
			<button class="logout-btn" onclick="window.location.href='/logout'">Log out</button>
		</div>

		<h2>User Information</h2>
		<div class="user-info">
			<div><label>UserId:</label> <span id="id"></span></div>
			<div><label>Name:</label> <span id="name"></span></div>
			<div><label>Age:</label> <span id="age"></span></div>
			<div><label>Gender:</label> <span id="gender"></span></div>
			<div><label>Date Of Birth:</label> <span id="dateOfBirth"></span></div>
			<div><label>Email:</label> <span id="email"></span></div>
			<div><label>Contact Number:</label> <span id="contactNumber"></span></div>
			<div><label>Address:</label> <span id="address"></span></div>
			<div><label>City:</label> <span id="city"></span></div>
			<div><label>State:</label> <span id="state"></span></div>
			<div><label>Country:</label> <span id="country"></span></div>
			<div><label>Postal Code:</label> <span id="postalCode"></span></div>
			<div><label>Preferred Treatment Date:</label> <span id="treatmentDate"></span></div>
			<div><label>Medical History:</label> <span id="medicalHistory"></span></div>
			<div><label>Current Medication:</label> <span id="medication"></span></div>
			<div><label>Passport Status:</label> <span id="passportStatus"></span></div>
			<div><label>Emergency Contact:</label> <span id="emergencyContact"></span></div>
			<div><label>Payment Status:</label> <span id="paymentStatus"></span></div>
			<div><label>Payment Mode:</label> <span id="paymentMode"></span></div>
		</div>

		<div class="document-section">
			<h3>Documents</h3>
			<table>
				<thead>
					<tr>
						<th>Document Name</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody id="documentTableBody">
					<!-- Dynamic document rows will be injected here -->
				</tbody>
			</table>

			<div class="upload-section">
				<h3>Upload Document</h3>
				<form id="uploadDocumentForm" action="/document/upload" method="post" enctype="multipart/form-data">
					<input type="hidden" name="userId" id="hiddenUserId" value="">
					<label for="files">Choose files to upload:</label>
					<input type="file" id="files" name="files" multiple required>
					<button type="submit" class="blue-btn">Upload</button>
				</form>
				<div id="message" class="message"></div>
			</div>

			<div id="deleteModal" class="modal">
				<div class="modal-content">
					<h3>Confirm Delete</h3>
					<p>Are you sure you want to delete this document?</p>
					<button id="confirmDelete" class="modal-button modal-confirm">Delete</button>
					<button id="cancelDelete" class="modal-button modal-cancel">Cancel</button>
				</div>
			</div>

			<button class="button" onclick="redirectToDashboard()">Back</button>
		</div>

		<script>
			const userId = window.location.pathname.split('/').pop();

			fetch(`/api/users/${userId}`)
				.then(response => response.json())
				.then(user => {
					document.getElementById('id').innerText = user.id;
					document.getElementById('name').innerText = user.name;
					document.getElementById('age').innerText = user.age;
					document.getElementById('gender').innerText = user.gender;
					document.getElementById('dateOfBirth').innerText = user.dateOfBirth;
					document.getElementById('email').innerText = user.email;
					document.getElementById('contactNumber').innerText = user.contactNumber;
					document.getElementById('address').innerText = user.address;
					document.getElementById('city').innerText = user.city;
					document.getElementById('state').innerText = user.state;
					document.getElementById('country').innerText = user.country;
					document.getElementById('postalCode').innerText = user.postalCode;
					document.getElementById('treatmentDate').innerText = user.preferredTreatmentDate;
					document.getElementById('medicalHistory').innerText = user.medicalHistory;
					document.getElementById('medication').innerText = user.currentMedication;
					document.getElementById('passportStatus').innerText = user.passportStatus;
					document.getElementById('emergencyContact').innerText = user.emergencyContact;
					document.getElementById('paymentStatus').innerText = user.paymentStatus;
					document.getElementById('paymentMode').innerText = user.paymentMode;
					document.getElementById('hiddenUserId').value = user.id;
					loadDocuments(userId);
				})
				.catch(error => console.error('Error fetching user data:', error));

			function loadDocuments(userId) {
				fetch(`/document/user/${userId}`)
					.then(response => response.json())
					.then(documents => {
						const tbody = document.getElementById('documentTableBody');
						tbody.innerHTML = ""; // Clear existing rows
						documents.forEach(doc => {
							const row = document.createElement('tr');
							row.innerHTML = `
                                <td>${doc.name}</td>
                                <td>
                                    <button class="blue-btn" onclick="viewDocument(${doc.id})">View</button>
                                    <button class="red-btn" onclick="showDeleteModal(${doc.id})">Delete</button>
                                </td>
                            `;
							tbody.appendChild(row);
						});
					})
					.catch(error => console.error('Error loading documents:', error));
			}

			document.getElementById('uploadDocumentForm').addEventListener('submit', function (event) {
				event.preventDefault(); // Prevent the default form submission

				const formData = new FormData(this); // Create F	ormData from the form
				console.log("Submitting User ID:", document.getElementById('hiddenUserId').value); // Debug line
				const messageDiv = document.getElementById('message'); // Message display div

				// Perform input validation (optional)
				const files = document.getElementById('files').files;
				if (files.length === 0) {
					messageDiv.textContent = "Please select at least one file.";
					messageDiv.className = "error-message";
					return;
				}

				// Send the form data to the server using Fetch API
				fetch('/document/upload/' + document.getElementById('hiddenUserId').value, {
					method: 'POST',
					body: formData
				})
					.then(response => {
						if (!response.ok) {
							throw new Error("Failed to upload files. Status: " + response.status);
						}
						return response.text(); // or response.json() based on your API response
					})
					.then(data => {
						// Display success message
						messageDiv.textContent = data;
						loadDocuments(userId);
						messageDiv.className = "success-message"; // Optionally set class for styling
					})
					.catch(error => {
						// Handle error and display message
						messageDiv.textContent = error.message; // Display error message
						messageDiv.className = "error-message"; // Optionally set class for styling
					});
			});

			async function viewDocument(documentId) {
				try {
					const response = await fetch(`/document/getDocument/${documentId}`);
					if (!response.ok) {
						throw new Error("Error fetching the PDF document.");
					}
					const blob = await response.blob();
					const url = URL.createObjectURL(blob);
					window.open(url, "_blank"); // Open in a new tab
				} catch (error) {
					console.error("Error viewing PDF:", error);
				}
			}

			function showDeleteModal(documentId) {
				documentIdToDelete = documentId; // Store the document ID for deletion
				const deleteModal = document.getElementById('deleteModal');
				deleteModal.style.display = "block"; // Show the modal
			}

			function hideDeleteModal() {
				const deleteModal = document.getElementById('deleteModal');
				deleteModal.style.display = "none"; // Hide the modal
				documentIdToDelete = null; // Reset the document ID
			}

			function deleteDocument() {
				if (documentIdToDelete !== null) {
					console.log(`Deleting document with ID: ${documentIdToDelete}`);
					fetch(`/document/deleteDocument/${documentIdToDelete}`, {
						method: 'DELETE'
					})
						.then(response => {
							if (response.ok) {
								console.log("Document deleted successfully");
								loadDocuments(userId); // Refresh the document list
							} else {
								console.error('Failed to delete document, status:', response.status);
							}
						})
						.catch(error => console.error('Error:', error))
						.finally(() => hideDeleteModal());
				}
			}


			// Event listeners for the modal buttons
			document.getElementById('confirmDelete').addEventListener('click', deleteDocument);
			document.getElementById('cancelDelete').addEventListener('click', hideDeleteModal);
			function redirectToDashboard() {
				window.location.href = "/users";
			}
		</script>

	</div>

</body>

</html>